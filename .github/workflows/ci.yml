name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

env:
  SERVER_PATH: backend

jobs:
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore server cache
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-server-node-modules-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-node-modules-

      - name: Install server dependencies
        run: npm ci
        working-directory: backend

      - name: Restore client cache
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-client-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-client-node-modules-

      - name: Install client dependencies
        run: npm ci
        working-directory: frontend

  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: install
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev')
    steps:
      - name: Extract version or branch
        id: version
        run: |
          VERSION="dev-${GITHUB_SHA::7}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Wait for deployment
        run: sleep 30

      - name: Verify deployment
        run: |
          echo "Backend deployment triggered for version ${{ env.VERSION }}"

  deploy-frontend:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: Extract branch and commit
        id: version
        run: |
          VERSION="dev-${GITHUB_SHA::7}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'
          
      - name: Wait for deployment
        run: sleep 30

      - name: Verify deployment
        run: |
          echo "Frontend deployment triggered for version ${{ env.VERSION }}"

  smoke-test:
    name: Smoke Test Deployment
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev')
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 10

      - name: Health check
        run: |
          echo "Testing backend health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "::error::Health check failed with status code: $response"
            exit 1
          fi
          echo "Health check passed ✓"

      - name: Test GET /centers endpoint
        run: |
          echo "Testing GET /centers endpoint..."
          response=$(curl -s -w "\n%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/centers)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$status_code" != "200" ]; then
            echo "::error::GET /centers failed with status code: $status_code"
            exit 1
          fi

          echo "Response: $body"
          echo "GET /centers test passed ✓"

      - name: Test GET /forms endpoint
        run: |
          echo "Testing GET /forms endpoint..."
          response=$(curl -s -w "\n%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/forms)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$status_code" != "200" ]; then
            echo "::error::GET /forms failed with status code: $status_code"
            exit 1
          fi

          echo "Response: $body"
          echo "GET /forms test passed ✓"

      - name: Deployment validation complete
        run: |
          echo "All smoke tests passed successfully"
          echo "Backend is healthy and responding correctly"