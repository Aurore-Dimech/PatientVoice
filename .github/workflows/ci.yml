name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - main
    tags:
      - "v*.*.*"
  pull_request:
    branches:
      - dev
      - main
  release: 
    types: [published] 

env:
  SERVER_PATH: backend

jobs:
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore server cache
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-server-node-modules-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-node-modules-

      - name: Install server dependencies
        run: npm ci
        working-directory: backend

      - name: Restore client cache
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-client-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-client-node-modules-

      - name: Install client dependencies
        run: npm ci
        working-directory: frontend

  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: install
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev')
    steps:
      - name: Extract version or branch
        id: version
        run: |
          VERSION="dev-${GITHUB_SHA::7}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Verify deploy
        run: |
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "Deploy verified"
              break
            fi
            echo "Waiting for deploy... ($i/10)"
            sleep 30
          done

      - name: Wait for deployment
        run: sleep 60

      - name: Verify deployment
        run: |
          echo "Backend deployment triggered for version ${{ env.VERSION }}"

  deploy-frontend:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: Extract branch and commit
        id: version
        run: |
          VERSION="dev-${GITHUB_SHA::7}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'
          
      - name: Wait for deployment
        run: sleep 30

      - name: Verify deployment
        run: |
          echo "Frontend deployment triggered for version ${{ env.VERSION }}"

  smoke-test:
    name: Smoke Test Deployment
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev')
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 120

      - name: Health check with retries
        run: |
          echo "Testing backend health endpoint..."
          for i in {1..3}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/health 2>&1 || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed ✓"
              break
            else
              echo "Attempt $i failed with status: $response. Retrying in 10s..."
              sleep 10
            fi
            if [ $i -eq 3 ]; then
              echo "::error::Health check failed after 3 attempts"
              exit 1
            fi
          done

      - name: Test GET /centers endpoint
        run: |
          echo "Testing GET /centers endpoint..."
          response=$(curl -s -w "\n%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/centers 2>&1)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$status_code" != "200" ]; then
            echo "::error::GET /centers failed with status code: $status_code. Response: $body"
            exit 1
          fi

          echo "Response: $body"
          echo "GET /centers test passed ✓"

      - name: Test GET /forms endpoint
        run: |
          echo "Testing GET /forms endpoint..."
          response=$(curl -s -w "\n%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/forms 2>&1)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$status_code" != "200" ]; then
            echo "::error::GET /forms failed with status code: $status_code. Response: $body"
            exit 1
          fi

          echo "Response: $body"
          echo "GET /forms test passed ✓"

      - name: Deployment validation complete
        run: |
          echo "All smoke tests passed successfully"
          echo "Backend is healthy and responding correctly"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: install
    if: github.event_name == 'release' && github.event.action == 'published' && github.ref_name == 'main'
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Deploy Backend to Prod Render
        run: |
          curl -X POST "${{ secrets.RENDER_PROD_BACKEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Deploy Frontend to Prod Render
        run: |
          curl -X POST "${{ secrets.RENDER_PROD_FRONTEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Verify Prod Deploys
        run: |
          echo "Production deploys triggered for version ${{ env.VERSION }}"

      - name: Wait for Prod Deploys
        run: sleep 120

      - name: Smoke Test Prod Backend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_PROD_BACKEND_URL }}/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "::error::Prod backend health check failed"
            exit 1
          fi
          echo "Prod backend health check passed ✓"